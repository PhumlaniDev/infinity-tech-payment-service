name: CI Workflow

permissions:
  issues: read
  contents: read
  actions: read
  security-events: write
  pull-requests: read

on:
  workflow_dispatch:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]

jobs:

  checkstyle:
    name: Checkstyle
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Run Checkstyle
        run: mvn --batch-mode checkstyle:check

  build:
    needs: checkstyle
    uses: PhumlaniDev/reusable-workflows/.github/workflows/java-maven-build-test.yml@main
    secrets: inherit

  sast:
    needs: build
    uses: PhumlaniDev/reusable-workflows/.github/workflows/java-maven-sast.yml@main
    secrets: inherit

  docker:
    needs: build
    uses: PhumlaniDev/reusable-workflows/.github/workflows/java-maven-docker.yml@main
    with:
      project_name: payment-service
    secrets: inherit

  sca:
    needs: docker
    uses: PhumlaniDev/reusable-workflows/.github/workflows/java-maven-sca.yml@main
    with:
      image_tag: ${{ needs.docker.outputs.image_tag }}
      project_name: payment-service
    secrets: inherit

  #  dast:
  #    needs: build
  #    name: Dynamic Application Security Testing (DAST)
  #    uses: PhumlaniDev/reusable-workflows/.github/workflows/dast.yml@main
  #    secrets:
  #      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  #      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  #    with:
  #      image-tag: '${{ secrets.DOCKERHUB_USERNAME }}/infinity-auth-service:latest'

  notify:
    uses: PhumlaniDev/reusable-workflows/.github/workflows/discord-notify.yml@main
    needs:
      - checkstyle
      - build
      - sast
      - sca
    if: always()
    with:
      status: >-
        ${{ (needs.unit-tests.result == 'success' && needs.sast.result == 'success' && needs.sca.result == 'success' && needs.dast.result == 'success') && 'success' || 'failure' }}
      title: "ðŸš€ Workflow Run - Combined Status"
      description: |
        Checkstyle: `${{ needs.checkstyle.result }}`
        Build: `${{ needs.build.result }}`
        SAST: `${{ needs.sast.result }}`
        SCA: `${{ needs.sca.result }}`
        Commit: `${{ github.sha }}`
        [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
      color: >-
        ${{ (needs.unit-tests.result == 'success' && needs.sast.result == 'success' && needs.sca.result == 'success' && needs.dast.result == 'success') && '3066993' || '15158332' }}
    secrets:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}